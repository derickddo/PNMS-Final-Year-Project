{% load custom_filters %}
<div class="container mx-auto px-4">
    <div class="flex justify-between ">
      <div>
        <h1 class="text-2xl font-bold">Dashboard</h1>
        <p class="mt-2">Welcome to the dashboard</p>
      </div>
      
      <div class="text-sm breadcrumbs hidden md:block">
        <ul>
          <li><a href="#populationProjection">Population Projection</a></li> 
          <li><a href="#needsAssessment">Needs Assessment</a></li> 
          <li><a href="#">Map Prediction</a></li>
        </ul>
      </div>
    </div>
    
    {% if population_projections %}
    <div id="populationProjection" class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-2 lg:grid-cols-3 h-fit">
      {% for population_projection in population_projections %}
          <!--Graph card-->
          <div class="card-bordered shadow-lg card relative card-item">
              <div class="dropdown dropdown-end absolute right-3 top-3">
                  <div tabindex="0" role="button" class="m-1 py-1 px-2 hover:bg-base-300 rounded-md">
                      <i class="fa-solid fas fa-ellipsis-h"></i>
                  </div>
                  <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                      <li>
                          <a class="edit" hx-trigger="click" hx-target="#modal-content" hx-on="htmx:afterOnLoad:my_modal_3.showModal()" hx-get="{% url 'crud' %}?mode=update&id={{ population_projection.pk }}">Edit</a>
                      </li>
                      <li>
                          <a hx-target="#modal-content" hx-swap="innerHTML" hx-get="{% url 'crud' %}?mode=delete&id={{ population_projection.pk }}" class="delete" data-value="{{ population_projection.slug }}" hx-on="htmx:afterOnLoad:my_modal_3.showModal()">Delete</a>
                      </li>
                  </ul>
              </div>
              <div class="card-body p-5">
                  <h2 class="card-title text-lg">{{ population_projection.title|truncatewords:3 }}</h2>
                  {% if population_projection.description %}
                      <p class="mb-2 text-xs">{{ population_projection.description }}</p>
                  {% else %}
                      <p class="mb-1">Population Projection from {{ population_projection.projections.all.0.base_year }} to {{ population_projection.projections.all.last.projecting_year|truncatewords:0 }}</p>
                  {% endif %}
                  <div>
                      {% with projections=population_projection.projections.all %}
                          {% with base_years=projections|get_base_years projected_population=projections|get_projected_population %}
                              <canvas class="populationProjectionChart" data-labels='{{ base_years }}' class="w-full" height="200" data-values='{{ projected_population }}'></canvas>
                          {% endwith %}
                      {% endwith %}
                  </div>
                  <button href="{% url 'population_projection' population_projection.slug %}" hx-get="{% url 'population_projection' population_projection.slug %}" class="btn btn-primary" hx-push-url="true" hx-target="#main" hx-swap="innerHTML">View Projection</button>
              </div>
          </div>
      {% endfor %}
  </div>
  

      {% else %}
      <div class="flex justify-center items-center h-[20rem]">
        <button hx-trigger="click" hx-get="{% url 'crud' %}?mode=create" hx-target="#modal-content" hx-swap="innerHTML" hx-on="htmx:afterOnLoad:my_modal_3.showModal()" class="btn btn-primary">
          + new projection
        </button>
      </div>
    {% endif %}

    <!--Needs Assessment-->
    <div class="mt-[4rem]" id="needsAssessment">
      <h2 class="text-xl font-bold mt-8">Needs Assessment</h2>
      <p class="mt-2 w-[30rem]">Recently created need assessments</p>

      
      {% if needs_assessments %}
      <div class="grid grid-cols-1 gap-4 mt-4 md:grid-cols-2 lg:grid-cols-3 h-fit">
        
        {% for need in needs_assessments %}
        <div class="card-bordered shadow-lg card  relative card-item ">
          <div class="card-body p-5">
            <div class="flex">
              <div>
                <h2 class="card-title text-lg mb-1 font-bold">Needs Assessment for {{ need.population_projection|truncatewords:0 }}</h2>
                <!--manual description-->
                <p class=" text-gray-500">Assessed need with in the {{need.sector}} sector</p>
              </div>
              
              <div class="dropdown dropdown-end absolute right-3 top-3">
                <div tabindex="0" role="button" class="m-1 py-1 px-2 hover:bg-base-300 rounded-md">
                  <i class="fa-solid fas fa-ellipsis-h"></i>
                </div>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                  <li>
                    <a class="edit" hx-trigger="click" hx-target="#modal-content" hx-on="htmx:afterOnLoad:my_modal_3.showModal()" hx-get="{% url 'manage_need_assessment' need.slug %}">Edit</a>
                  </li>
                  <li>
                    <a hx-target="#modal-content" hx-swap="innerHTML" hx-get="{% url 'crud' %}?mode=delete&id={{ need.pk }}" class="delete" data-value="{{ need.slug }}" hx-on="htmx:afterOnLoad:my_modal_3.showModal()">Delete</a>
                  </li>
                </ul>
              </div>
            </div>
            
            <!--Categories bage for needs type-->
            <div class="flex items-center gap-2 mt-2">
              <span>
                <i class="fa-solid fa-tags"></i>
                <span class="font-medium">Need Types:</span>
              </span>
              <div class="flex gap-2">
                {% for needs_type in need.needs.all|get_needs_type %}
                <span class="badge badge-primary">{{ needs_type }}</span>
                {% endfor %}
              </div>
            </div>

            <div class="grid grid-cols-1 gap-y-2">
              <div class="flex gap-2">
                <span>
                  <i class="fa-solid fa-calendar-days"></i>
                  <span class="font-medium">Year:</span>
                </span>
                <span>{{ need.population_projection.projections.all.0.base_year }} - {{ need.population_projection.projections.last.projecting_year }}</span>
              </div>

              <div class="flex gap-2">
                <span>
                  <i class="fa-solid fa-map-marked-alt"></i>
                  <span class="font-medium">Area:</span>
                </span>
                <span>{{ need.population_projection.content_object.name|title }}</span>
              </div>

              <div class="flex gap-2">
                <span>
                  <i class="fa-solid fa-users"></i>
                  <span class="font-medium">Base Population:</span>
                </span>
                <span>{{ need.population_projection.projections.all.0.base_population }}</span>
              </div>

              <div class="flex gap-2">
                <span>
                  <i class="fa-solid fa-person-arrow-up-from-line"></i>
                  <span class="font-medium">Projected Population:</span>
                </span>
                <span>{{ need.population_projection.projections.last.projected_population }}</span>
              </div>

              <div class="flex gap-2">
                <span>
                  <i class="fa-solid fa-map-marked-alt"></i>
                  <span class="font-medium">Area Type:</span>
                </span>
                <span>{{ need.population_projection.area_type|title }}</span>
              </div>

              <div class="flex gap-2">
                <span>
                  <i class="fa-solid fa-map-marked-alt"></i>
                  <span class="font-medium">Sector:</span>
                </span>
                <span>{{ need.sector }}</span>
              </div>
            </div>
              
            
            

            <!-- <table class="table table-sm table-zebra w-full">  
              <thead>
                <tr>
                  <th>Need</th>
                  <th>Available</th>
                </tr>
              </thead>
              <tbody>
                {% for need_item in need.needs.all %}
                <tr class="{% if forloop.counter > 3 %}hidden{% endif %} need-row">
                  <td>{{ need_item.content_object.type_name }}</td>
                  <td>{{ need_item.content_object.available }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table> -->

           
            <button hx-get="{% url 'manage_need_assessment' need.slug %}" hx-target="#main" hx-swap="innerHTML" hx-push-url="true" href="{% url 'manage_need_assessment' need.slug %}" class="btn btn-primary">View more</button>
             
            
          </div>
          
        </div>
        {% endfor %}

      </div>
      {% else %}
      <div class="flex justify-center items-center h-[20rem]">
        <button hx-trigger="click" hx-push-url="{% url 'create_need_assessment' %}" hx-get="{% url 'create_need_assessment' %}"hx-target="#main" hx-on="htmx:afterOnLoad:handleSectorSelection" hx-swap="innerHTML"class="btn btn-primary">
          + new assessment
        </button>
      </div>
      {% endif %}
        
          
    </div>

  </div>
